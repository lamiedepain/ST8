<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <title>Gestion des agents</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/agents.css">
  <link rel="stylesheet" href="/css/system.css">
  <link rel="icon" href="/assets/icons/ST8_blue.svg" type="image/svg+xml">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="ST8 PRO - Gestion des agents">
  <meta name="theme-color" content="#2C6EBD">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/assets/icons/ST8_multi.svg">
</head>

<body class="theme-blue">
  <header class="theme-blue" data-square="AG" data-title="Gestion des agents" role="banner">
    <div data-include="header"></div>
  </header>
  <main role="main">
    <div class="main-toolbar">
      <div class="toolbar-left">
        <select id="service-filter" class="service-selector" onchange="filterAgents()">
          <option value="">üè¢ Tous les services</option>
          <option value="VOIRIE">üöß VOIRIE</option>
          <option value="ESPACES_VERTS">üå≥ ESPACES VERTS</option>
          <option value="ENCADRANTS">üëî ENCADRANTS</option>
          <option value="MAGASIN">üì¶ MAGASIN</option>
          <option value="ENTRETIEN_BATIMENT">üîß ENTRETIEN BATIMENT</option>
        </select>
        <input id="search-input" class="search-input" type="search" placeholder="Rechercher (nom, pr√©nom, matricule)"
          oninput="searchAgents()" />
        <div class="quick-stats">
          <span id="agents-count">0 agents</span> ‚Ä¢ <span id="services-count">0 services</span>
        </div>
      </div>
      <div class="toolbar-right">
        <button class="btn-primary" onclick="showAddAgent()">+ Ajouter</button>
        <button onclick="exportAgents()">‚§ì Exporter</button>
        <button onclick="forceSaveAgents()">üíæ Sauvegarder (forcer)</button>
        <button id="bulk-edit-btn" onclick="toggleBulkEdit()">‚úèÔ∏è √âdition group√©e</button>
      </div>
    </div>

    <div id="bulk-edit-panel" style="display:none; margin: 12px 0;">
      <div style="display:flex; gap:10px; align-items:center;">
        <select id="bulk-service" class="service-selector" onchange="loadServiceAgents()">
          <option value="">S√©lectionner un service</option>
          <option value="VOIRIE">VOIRIE</option>
          <option value="ESPACES_VERTS">ESPACES VERTS</option>
          <option value="ENCADRANTS">ENCADRANTS</option>
          <option value="MAGASIN">MAGASIN</option>
          <option value="ENTRETIEN_BATIMENT">ENTRETIEN BATIMENT</option>
        </select>
      </div>
      <div id="bulk-edit-grid" style="margin-top:10px;"></div>
    </div>

    <div class="agents-grid" id="agents-grid"></div>

    <div id="agent-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modal-title">Nouvel agent</h2>
          <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <form id="agent-form" class="agent-form">
          <div class="form-grid">
            <div class="accordion-section">
              <div class="accordion-header" onclick="toggleAccordion(this)">
                <div class="accordion-title">
                  <span class="accordion-icon">‚ñ∂</span>
                  Infos principales
                </div>
              </div>
              <div class="accordion-content">
                <div class="form-row">
                  <input id="matricule" name="matricule" placeholder="Matricule" required />
                  <select id="grade" name="grade">
                    <option value="Technicien Principal de 1√®re classe">Technicien Principal de 1√®re classe</option>
                    <option value="Technicien principal de 2e classe">Technicien principal de 2e classe</option>
                    <option value="Technicien">Technicien</option>
                    <option value="Adjoint technique principal de 1√®re classe">Adjoint technique principal de 1√®re
                      classe</option>
                    <option value="Adjoint technique principal de 2e classe">Adjoint technique principal de 2e classe
                    </option>
                    <option value="Adjoint technique territorial">Adjoint technique territorial</option>
                    <option value="Agent de maitrise principal">Agent de maitrise principal</option>
                    <option value="Agent de maitrise">Agent de maitrise</option>
                  </select>
                </div>
                <div class="form-row">
                  <input id="nom" name="nom" placeholder="Nom" required />
                  <input id="prenom" name="prenom" placeholder="Pr√©nom" required />
                </div>
                <div class="form-row">
                  <select id="service" name="service" onchange="updateServiceInfo()">
                    <option value="">Service</option>
                    <option value="VOIRIE">VOIRIE</option>
                    <option value="ESPACES_VERTS">ESPACES VERTS</option>
                    <option value="ENCADRANTS">ENCADRANTS</option>
                    <option value="MAGASIN">MAGASIN</option>
                    <option value="ENTRETIEN_BATIMENT">ENTRETIEN BATIMENT</option>
                  </select>
                  <select id="statut" name="statut">
                    <option value="Titulaire">Titulaire</option>
                    <option value="Contractuel">Contractuel</option>
                  </select>
                </div>
                <div class="form-row">
                  <input id="email" name="email" placeholder="Email" type="email" />
                  <input id="telephone" name="telephone" placeholder="T√©l√©phone" />
                </div>
                <div class="form-row">
                  <input id="anniversaire" name="anniversaire" type="date" placeholder="Anniversaire" />
                  <div></div>
                </div>
                <div id="service-info" class="service-info"></div>
              </div>
            </div>

            <div class="accordion-section">
              <div class="accordion-header" onclick="toggleAccordion(this)">
                <div class="accordion-title">
                  <span class="accordion-icon">‚ñ∂</span>
                  Permis
                </div>
              </div>
              <div class="accordion-content">
                <div id="permis-options" class="checkbox-grid"></div>
              </div>
            </div>

            <div class="accordion-section">
              <div class="accordion-header" onclick="toggleAccordion(this)">
                <div class="accordion-title">
                  <span class="accordion-icon">‚ñ∂</span>
                  CACES
                </div>
              </div>
              <div class="accordion-content">
                <div id="caces-options" class="checkbox-grid"></div>
              </div>
            </div>

            <div class="accordion-section">
              <div class="accordion-header" onclick="toggleAccordion(this)">
                <div class="accordion-title">
                  <span class="accordion-icon">‚ñ∂</span>
                  Comp√©tences
                </div>
              </div>
              <div class="accordion-content">
                <div id="competences-options" class="checkbox-grid"></div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" onclick="closeModal()">Annuler</button>
            <button type="submit" class="btn-primary">Enregistrer</button>
          </div>
        </form>
      </div>
    </div>
  </main>
  <div data-include="fab"></div>
  <footer data-include="footer" role="contentinfo"></footer>
  <script src="/js/include-partials.js?v=2"></script>
  <script src="/js/apps-data.js?v=2"></script>
  <script src="/js/script.js?v=2"></script>
  <script src="/js/api-sync.js?v=2"></script>
  <script src="/js/notify.js?v=2"></script>
  <script>
    // Variables globales pour la gestion des agents
    let agentsData = [];
    let currentEditAgent = null;
    let bulkEditMode = false;
    let referentielsData = { permis: {}, caces: {}, competences: {} };

    // Initialisation au chargement de la page
    document.addEventListener('DOMContentLoaded', function () {
      applyStoredTheme();
      initFab();
      loadAgentsData();
    });

    // Chargement des donn√©es d'agents
    async function loadAgentsData() {
      try {
        const data = await ApiSync.fetchAgentsSource();
        agentsData = data.agents || [];
        referentielsData = data.referentiels || referentielsData;
        displayAgents();
        updateStats();
        updateServiceFilter();
        renderFormOptions();
      } catch (error) {
        console.error('Erreur lors du chargement des agents:', error);
        agentsData = [];
        displayAgents();
      }
    }

    // Affichage des agents
    function displayAgents() {
      const grid = document.getElementById('agents-grid');
      const serviceFilter = document.getElementById('service-filter').value;
      const searchTerm = document.getElementById('search-input').value.toLowerCase();

      let filteredAgents = agentsData;

      // Filtre par service
      if (serviceFilter) {
        filteredAgents = filteredAgents.filter(agent => agent.service === serviceFilter);
      }

      // Filtre par recherche
      if (searchTerm) {
        filteredAgents = filteredAgents.filter(agent =>
          agent.nom.toLowerCase().includes(searchTerm) ||
          agent.prenom.toLowerCase().includes(searchTerm) ||
          agent.matricule.toLowerCase().includes(searchTerm)
        );
      }

      // Groupement par service
      const agentsByService = {};
      filteredAgents.forEach(agent => {
        if (!agentsByService[agent.service]) {
          agentsByService[agent.service] = [];
        }
        agentsByService[agent.service].push(agent);
      });

      // Construction du HTML
      let html = '';
      const serviceOrder = ['VOIRIE', 'ESPACES_VERTS', 'ENCADRANTS', 'MAGASIN', 'ENTRETIEN_BATIMENT'];
      Object.keys(agentsByService)
        .sort((a, b) => {
          // Toujours VOIRIE en premier, puis selon serviceOrder, puis alpha
          if (a === 'VOIRIE') return -1;
          if (b === 'VOIRIE') return 1;
          const ia = serviceOrder.indexOf(a);
          const ib = serviceOrder.indexOf(b);
          if (ia === -1 && ib === -1) return a.localeCompare(b);
          if (ia === -1) return 1;
          if (ib === -1) return -1;
          return ia - ib;
        })
        .forEach(service => {
          const agents = agentsByService[service];
          const serviceConfig = getServiceConfig(service);
          html += `
        <div class="service-group" data-service="${service}" style="background:${serviceConfig.bg || '#f8fafc'};border-radius:16px;margin-bottom:24px;padding:8px 0;">
          <div class="service-header">
            <h3 class="service-title" style="color: ${serviceConfig.color}">
              ${serviceConfig.icon} ${service.replace('_', ' ')}
            </h3>
            <div class="service-stats">
              <span class="service-count">${agents.length} agent${agents.length > 1 ? 's' : ''}</span>
            </div>
          </div>
          <div class="service-agents">
            ${agents.map(agent => createAgentCard(agent)).join('')}
          </div>
        </div>`;
        });

      if (html === '') {
        html = '<div class="no-results">Aucun agent trouv√©</div>';
      }

      grid.innerHTML = html;
    }

    // Cr√©ation d'une carte agent
    function createAgentCard(agent) {
      const serviceConfig = getServiceConfig(agent.service);
      const permisHTML = agent.permis ? agent.permis.map(p => {
        const v = agent.permis_validites && agent.permis_validites[p] ? ` (valide jusqu'au ${agent.permis_validites[p]})` : '';
        return `<span class="badge badge-permis" title="${p}${v}">${p}</span>`;
      }).join(' ') : '';
      const cacesHTML = agent.caces ? agent.caces.map(c => {
        const v = agent.caces_validites && agent.caces_validites[c] ? ` (valide jusqu'au ${agent.caces_validites[c]})` : '';
        return `<span class="badge badge-caces" title="${formatCaces(c)}${v}">${formatCaces(c)}</span>`;
      }).join(' ') : '';
      const competencesHTML = agent.competences ? agent.competences.map(c => `<span class="competence-tag">${c}</span>`).join(' ') : '';

      return `
  <div class="agent-card" data-matricule="${agent.matricule}" style="border-left: 4px solid ${serviceConfig.color}">
    <div class="agent-header">
            <div class="agent-name">
                <strong>${agent.nom}</strong> ${agent.prenom}
            </div>
            <div class="agent-actions">
                <button onclick="editAgent('${agent.matricule}')" class="btn-icon" title="Modifier">‚úèÔ∏è</button>
                <button onclick="deleteAgent('${agent.matricule}')" class="btn-icon btn-danger" title="Supprimer">üóëÔ∏è</button>
            </div>
        </div>
        <div class="agent-info">
            <div class="agent-detail">
                <span class="label">Matricule:</span>
                <span>${agent.matricule}</span>
            </div>
            <div class="agent-detail">
                <span class="label">Grade:</span>
                <span>${agent.grade}</span>
            </div>
            <div class="agent-detail">
                <span class="label">Statut:</span>
                <span class="badge badge-statut">${agent.statut}</span>
            </div>
            <div class="agent-detail">
                <span class="label">Email:</span>
                <span><a href="mailto:${agent.email}">${agent.email}</a></span>
            </div>
            ${permisHTML ? `<div class="agent-badges"><strong>Permis:</strong> ${permisHTML}</div>` : ''}
            ${cacesHTML ? `<div class="agent-badges"><strong>CACES:</strong> ${cacesHTML}</div>` : ''}
            ${competencesHTML ? `<div class="agent-competences"><strong>Comp√©tences:</strong> ${competencesHTML}</div>` : ''}
        </div>
    </div>`;
    }

    // Configuration des services
    function getServiceConfig(service) {
      const configs = {
        'VOIRIE': { color: 'var(--acc-voirie)', icon: 'üöß', bg: '#e0f7fa' },
        'ESPACES_VERTS': { color: 'var(--acc-espaces-verts)', icon: 'üå≥', bg: '#e6ffe6' },
        'ENCADRANTS': { color: 'var(--acc-encadrants)', icon: 'üëî', bg: '#f3e8ff' },
        'MAGASIN': { color: 'var(--acc-magasin)', icon: 'üì¶', bg: '#fffbe6' },
        'ENTRETIEN_BATIMENT': { color: 'var(--acc-entretien)', icon: 'üîß', bg: '#f0f4c3' }
      };
      return configs[service] || { color: '#94a3b8', icon: '‚ùì', bg: '#f8fafc' };
    }

    // Formatage des CACES
    function formatCaces(caces) {
      const formats = {
        'R482_A': 'R482 A',
        'R482_B1': 'R482 B1',
        'R482_B2': 'R482 B2',
        'R482_C1': 'R482 C1',
        'R482_C2': 'R482 C2',
        'R482_C3': 'R482 C3',
        'R482_D': 'R482 D',
        'R482_E': 'R482 E',
        'R482_F': 'R482 F',
        'R482_G': 'R482 G',
        'R486_A': 'R486 A',
        'R486_B': 'R486 B',
        'R489_1A': 'R489 1A',
        'R489_3': 'R489 3',
        'R489_5': 'R489 5',
        'R490': 'R490'
      };
      return formats[caces] || caces.replace('_', ' ');
    }

    // Mise √† jour des statistiques
    function updateStats() {
      const agentsCount = document.getElementById('agents-count');
      const servicesCount = document.getElementById('services-count');

      const services = [...new Set(agentsData.map(agent => agent.service))];

      if (agentsCount) agentsCount.textContent = `${agentsData.length} agents`;
      if (servicesCount) servicesCount.textContent = `${services.length} services`;
    }

    // Mise √† jour du filtre de service
    function updateServiceFilter() {
      const serviceFilter = document.getElementById('service-filter');
      if (!serviceFilter) return;

      const services = [...new Set(agentsData.map(agent => agent.service))];
      const serviceCounts = {};

      services.forEach(service => {
        serviceCounts[service] = agentsData.filter(agent => agent.service === service).length;
      });

      const totalCount = agentsData.length;
      serviceFilter.querySelector('option[value=""]').textContent = `üè¢ Tous les services (${totalCount} agents)`;

      // Mise √† jour des compteurs par service
      services.forEach(service => {
        const option = serviceFilter.querySelector(`option[value="${service}"]`);
        if (option) {
          const serviceConfig = getServiceConfig(service);
          option.textContent = `${serviceConfig.icon} ${service.replace('_', ' ')} (${serviceCounts[service]})`;
        }
      });

    }

    // Rendu des options (comp√©tences, permis, caces) dans le formulaire
    function renderFormOptions() {
      // Comp√©tences
      const compContainer = document.getElementById('competences-options');
      if (compContainer) {
        const comps = referentielsData.competences ? Object.keys(referentielsData.competences) : [];
        comps.sort((a, b) => a.localeCompare(b));
        compContainer.innerHTML = comps.map(code => {
          const desc = referentielsData.competences[code] || '';
          return `<label title="${desc}"><input type="checkbox" name="competences" value="${code}"> ${code}</label>`;
        }).join('');
      }

      // Permis avec date
      const permisContainer = document.getElementById('permis-options');
      if (permisContainer) {
        const permis = referentielsData.permis ? Object.keys(referentielsData.permis) : ['B', 'BE', 'C', 'CE'];
        permisContainer.innerHTML = permis.map(code => {
          const id = `permis-date-${code}`;
          const title = referentielsData.permis && referentielsData.permis[code] ? referentielsData.permis[code] : '';
          return `<div class="option-with-date" title="${title}">
        <label><input type="checkbox" name="permis" value="${code}"> ${code}</label>
        <input type="date" id="${id}" aria-label="Validit√© ${code}">
      </div>`;
        }).join('');
      }

      // CACES avec date (R482, R486, R489, R490)
      const cacesContainer = document.getElementById('caces-options');
      if (cacesContainer) {
        const base = referentielsData.caces || {};
        const extra = {
          'R482_E': 'Engins de manutention',
          'R486_B': 'PEMP √©l√©vation multidirectionnelle',
          'R489_1A': 'Chariots 1A',
          'R489_3': 'Chariots 3',
          'R489_5': 'Chariots 5',
          'R490': 'Grues auxiliaires'
        };
        const all = { ...base, ...extra };
        const codes = Object.keys(all).sort();
        cacesContainer.innerHTML = codes.map(code => {
          const id = `caces-date-${code}`;
          const title = all[code] || '';
          return `<div class="option-with-date" title="${title}">
        <label><input type="checkbox" name="caces" value="${code}"> ${formatCaces(code)}</label>
        <input type="date" id="${id}" aria-label="Validit√© ${formatCaces(code)}">
      </div>`;
        }).join('');
      }
    }

    // Filtrage des agents
    function filterAgents() {
      displayAgents();
    }

    // Recherche d'agents
    function searchAgents() {
      displayAgents();
    }

    // Afficher le modal d'ajout d'agent
    function showAddAgent() {
      currentEditAgent = null;
      document.getElementById('modal-title').textContent = 'Nouvel agent';
      document.getElementById('agent-form').reset();
      document.getElementById('agent-modal').style.display = 'block';
      generateEmail();
    }

    // √âdition d'un agent
    function editAgent(matricule) {
      currentEditAgent = agentsData.find(agent => agent.matricule === matricule);
      if (!currentEditAgent) return;

      document.getElementById('modal-title').textContent = 'Modifier l\'agent';

      // Remplissage du formulaire
      document.getElementById('matricule').value = currentEditAgent.matricule;
      ensureSelectOption('grade', currentEditAgent.grade);
      document.getElementById('grade').value = currentEditAgent.grade || '';
      document.getElementById('nom').value = currentEditAgent.nom;
      document.getElementById('prenom').value = currentEditAgent.prenom;
      document.getElementById('service').value = currentEditAgent.service;
      document.getElementById('statut').value = currentEditAgent.statut || 'Titulaire';
      document.getElementById('email').value = currentEditAgent.email;
      document.getElementById('telephone').value = currentEditAgent.telephone || '';
      document.getElementById('anniversaire').value = currentEditAgent.anniversaire || '';

      // Cocher les permis
      document.querySelectorAll('input[name="permis"]').forEach(input => {
        const code = input.value;
        input.checked = currentEditAgent.permis && currentEditAgent.permis.includes(code);
        const dateEl = document.getElementById(`permis-date-${code}`);
        if (dateEl && currentEditAgent.permis_validites && currentEditAgent.permis_validites[code]) {
          dateEl.value = currentEditAgent.permis_validites[code];
        } else if (dateEl) {
          dateEl.value = '';
        }
      });

      // Cocher les CACES
      document.querySelectorAll('input[name="caces"]').forEach(input => {
        const code = input.value;
        input.checked = currentEditAgent.caces && currentEditAgent.caces.includes(code);
        const dateEl = document.getElementById(`caces-date-${code}`);
        if (dateEl && currentEditAgent.caces_validites && currentEditAgent.caces_validites[code]) {
          dateEl.value = currentEditAgent.caces_validites[code];
        } else if (dateEl) {
          dateEl.value = '';
        }
      });

      // Remplir les comp√©tences
      document.querySelectorAll('input[name="competences"]').forEach(input => {
        input.checked = currentEditAgent.competences && currentEditAgent.competences.includes(input.value);
      });

      document.getElementById('agent-modal').style.display = 'block';
      updateServiceInfo();
    }

    // Suppression d'un agent
    function deleteAgent(matricule) {
      if (!confirm('√ätes-vous s√ªr de vouloir supprimer cet agent ?')) return;

      const index = agentsData.findIndex(agent => agent.matricule === matricule);
      if (index !== -1) {
        // remove locally
        agentsData.splice(index, 1);
        // try server delete (best-effort)
        fetch('/api/agents/' + encodeURIComponent(matricule), { method: 'DELETE' })
          .then(r => { if (r.ok) console.log('Deleted on server'); else console.warn('Server delete returned', r.status); })
          .catch(e => { console.warn('Server delete failed', e); });
        // update UI and local storage
        saveAgentsData();
        displayAgents();
        updateStats();
        updateServiceFilter();
      }
    }

    // Fermeture du modal
    function closeModal() {
      document.getElementById('agent-modal').style.display = 'none';
      currentEditAgent = null;
    }

    // Soumission du formulaire
    document.getElementById('agent-form').addEventListener('submit', function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const agent = {
        matricule: formData.get('matricule') || document.getElementById('matricule').value,
        nom: document.getElementById('nom').value.toUpperCase(),
        prenom: document.getElementById('prenom').value,
        grade: document.getElementById('grade').value,
        service: document.getElementById('service').value,
        statut: document.getElementById('statut').value,
        email: document.getElementById('email').value,
        telephone: document.getElementById('telephone').value,
        anniversaire: document.getElementById('anniversaire').value || '',
        permis: [...document.querySelectorAll('input[name="permis"]:checked')].map(input => input.value),
        caces: [...document.querySelectorAll('input[name="caces"]:checked')].map(input => input.value),
        competences: [...document.querySelectorAll('input[name="competences"]:checked')].map(input => input.value),
        permis_validites: (() => {
          const out = {}; document.querySelectorAll('input[name="permis"]').forEach(input => {
            const code = input.value; const dateEl = document.getElementById(`permis-date-${code}`);
            if (input.checked && dateEl && dateEl.value) out[code] = dateEl.value;
          }); return out;
        })(),
        caces_validites: (() => {
          const out = {}; document.querySelectorAll('input[name="caces"]').forEach(input => {
            const code = input.value; const dateEl = document.getElementById(`caces-date-${code}`);
            if (input.checked && dateEl && dateEl.value) out[code] = dateEl.value;
          }); return out;
        })(),
        date_entree: '',
        presences: {}
      };

      if (currentEditAgent) {
        // Modification
        const index = agentsData.findIndex(a => a.matricule === currentEditAgent.matricule);
        if (index !== -1) {
          agentsData[index] = { ...currentEditAgent, ...agent };
        }
      } else {
        // Ajout
        if (agentsData.find(a => a.matricule === agent.matricule)) {
          alert('Ce matricule existe d√©j√† !');
          return;
        }
        agentsData.push(agent);
      }

      saveAgentsData();
      displayAgents();
      updateStats();
      updateServiceFilter();
      closeModal();
    });

    // G√©n√©ration automatique de l'email
    function generateEmail() {
      const nom = document.getElementById('nom').value.toLowerCase();
      const prenom = document.getElementById('prenom').value.toLowerCase();

      if (nom && prenom) {
        const email = `${prenom.charAt(0)}.${nom}@bordeaux-metropole.fr`;
        document.getElementById('email').value = email;
      }
    }

    // Mise √† jour automatique de l'email lors de la saisie
    document.getElementById('nom').addEventListener('input', generateEmail);
    document.getElementById('prenom').addEventListener('input', generateEmail);

    // Mise √† jour des informations de service
    function updateServiceInfo() {
      const service = document.getElementById('service').value;
      const serviceInfo = document.getElementById('service-info');

      if (!serviceInfo) return;

      const serviceConfig = getServiceConfig(service);
      const serviceAgents = agentsData.filter(agent => agent.service === service);

      if (service) {
        serviceInfo.innerHTML = `
            <div class="service-preview" style="border-left: 4px solid ${serviceConfig.color}">
                <strong>${serviceConfig.icon} ${service.replace('_', ' ')}</strong>
                <span>${serviceAgents.length} agents dans ce service</span>
            </div>
        `;
      } else {
        serviceInfo.innerHTML = '';
      }
    }

    // Gestion des accord√©ons
    function toggleAccordion(header) {
      const content = header.nextElementSibling;
      const icon = header.querySelector('.accordion-icon');

      header.classList.toggle('active');
      content.classList.toggle('active');

      if (content.classList.contains('active')) {
        content.style.maxHeight = content.scrollHeight + 'px';
        icon.textContent = '‚ñº';
      } else {
        content.style.maxHeight = '0px';
        icon.textContent = '‚ñ∂';
      }
    }

    // Mode √©dition group√©e
    function toggleBulkEdit() {
      bulkEditMode = !bulkEditMode;
      const panel = document.getElementById('bulk-edit-panel');
      const button = document.getElementById('bulk-edit-btn');

      if (bulkEditMode) {
        panel.style.display = 'block';
        button.textContent = '‚ùå Fermer √©dition';
        button.classList.add('active');
      } else {
        panel.style.display = 'none';
        button.textContent = '‚úèÔ∏è √âdition group√©e';
        button.classList.remove('active');
      }
    }

    // Chargement des agents d'un service pour l'√©dition group√©e
    function loadServiceAgents() {
      const service = document.getElementById('bulk-service').value;
      const grid = document.getElementById('bulk-edit-grid');

      if (!service) {
        grid.innerHTML = '';
        return;
      }

      const serviceAgents = agentsData.filter(agent => agent.service === service);

      let html = '<div class="bulk-agents-list">';
      serviceAgents.forEach(agent => {
        html += `
        <div class="bulk-agent-item" data-matricule="${agent.matricule}">
            <div class="bulk-agent-info">
                <strong>${agent.nom} ${agent.prenom}</strong>
                <span>${agent.matricule}</span>
            </div>
            <div class="bulk-agent-actions">
                <button onclick="editAgent('${agent.matricule}')">‚úèÔ∏è</button>
            </div>
        </div>`;
      });
      html += '</div>';

      grid.innerHTML = html;
    }

    // Sauvegarde des donn√©es (simulation - en r√©alit√© il faudrait un serveur)
    async function saveAgentsData() {
      try {
        // En mode d√©veloppement, on essaie d'envoyer au serveur si disponible
        console.log('Sauvegarde des donn√©es (local + tentative serveur):', agentsData);
        try {
          const ok = await ApiSync.postAgents(agentsData);
          if (ok) {
            console.log('Saved to server');
            if (typeof ST8Notify !== 'undefined') ST8Notify.showToast('Agents sauvegard√©s sur le serveur', 'success');
          } else {
            console.warn('Server save not successful');
            if (typeof ST8Notify !== 'undefined') ST8Notify.showToast('Serveur indisponible ‚Äî sauvegarde locale effectu√©e', 'warn');
          }
        } catch (e) { console.warn('Server not available, will save locally only', e); if (typeof ST8Notify !== 'undefined') ST8Notify.showToast('Serveur indisponible ‚Äî sauvegarde locale effectu√©e', 'warn'); }
        // Synchronisation avec le Planning (localStorage)
        try {
          const now = new Date().toISOString();
          const serviceToGroup = (s) => {
            switch (s) {
              case 'VOIRIE': return 'AGENTS VOIRIE ST 8';
              case 'ESPACES_VERTS': return 'AGENTS ESPACE VERT ST 8';
              case 'ENCADRANTS': return 'ENCADRANTS';
              case 'MAGASIN': return 'MAGASIN ST 8';
              case 'ENTRETIEN_BATIMENT': return 'AGENT ENTRETIEN BATIMENT ST 8';
              default: return s || 'AUTRES';
            }
          };
          const grouped = {};
          (agentsData || []).forEach(a => {
            const g = serviceToGroup(a.service);
            if (!grouped[g]) grouped[g] = [];
            grouped[g].push({
              matricule: a.matricule || '',
              name: `${(a.nom || '').toUpperCase()} ${(a.prenom || '')}`.trim(),
              grade: a.grade || ''
            });
          });
          // 1) Fallback agents pour planning
          const fallback = { agents: grouped, date: now };
          localStorage.setItem('agents_st8_autosave', JSON.stringify(fallback));
          // 2) Mettre √† jour l'√©tat planning si existant (sans toucher aux autres cl√©s)
          try {
            const raw = localStorage.getItem('planning_st8_autosave');
            if (raw) {
              const planning = JSON.parse(raw);
              planning.agents = grouped; // le planning utilisera getAgentsByGroup()
              planning.date_agents = now;
              localStorage.setItem('planning_st8_autosave', JSON.stringify(planning));
            }
          } catch { }
        } catch (e) { console.warn('Sync planning localStorage √©chou√©:', e); }

        return true;
      } catch (error) {
        console.error('Erreur lors de la sauvegarde:', error);
        if (typeof ST8Notify !== 'undefined') ST8Notify.showToast('Erreur lors de la sauvegarde', 'error');
        return false;
      }
    }

    // Forcer l'envoi des agents au serveur (bouton de sauvegarde forc√©e)
    async function forceSaveAgents() {
      try {
        const db = document.getElementById('debug-banner');
        if (db) { db.textContent = 'Envoi forc√© en cours...'; db.style.background = '#0ea5a0'; }
        const ok = await ApiSync.postAgents(agentsData);
        if (ok) {
          if (db) { db.textContent = 'Envoi forc√© r√©ussi'; db.style.background = '#0f9d58'; }
          if (typeof ST8Notify !== 'undefined') ST8Notify.showToast('Envoi forc√© : agents sauvegard√©s', 'success');
        } else {
          if (db) { db.textContent = 'Envoi forc√© √©chou√© (serveur indisponible)'; db.style.background = '#f59e0b'; }
          if (typeof ST8Notify !== 'undefined') ST8Notify.showToast('Envoi forc√© √©chou√© ‚Äî serveur indisponible', 'error');
        }
      } catch (e) {
        console.error('forceSaveAgents failed', e);
        if (typeof ST8Notify !== 'undefined') ST8Notify.showToast('Erreur lors de l\'envoi forc√©', 'error');
      }
    }

    // Export des agents
    function exportAgents() {
      const dataStr = JSON.stringify({
        metadata: {
          title: "Export agents ST8",
          version: "2.0",
          date: new Date().toISOString().split('T')[0],
          exported_on: new Date().toISOString()
        },
        agents: agentsData
      }, null, 2);

      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);

      const link = document.createElement('a');
      link.href = url;
      link.download = `agents_export_${new Date().toISOString().split('T')[0]}.json`;
      link.click();

      URL.revokeObjectURL(url);
    }

    // Fermer le modal en cliquant √† l'ext√©rieur
    window.addEventListener('click', function (event) {
      const modal = document.getElementById('agent-modal');
      if (event.target === modal) {
        closeModal();
      }
    });

    // Utilitaire: ajoute l'option si absente (compat valeurs anciennes)
    function ensureSelectOption(selectId, value) {
      const sel = document.getElementById(selectId);
      if (!sel) return;
      if (!value) return;
      if (![...sel.options].some(o => o.value === value)) {
        const opt = document.createElement('option'); opt.value = value; opt.textContent = value; sel.appendChild(opt);
      }
    }
  </script>
</body>

</html>