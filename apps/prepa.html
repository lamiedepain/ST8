<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>prepa.html — Fiche chantier — ST8 PRO</title>
  <style>
    :root{
      --brand:#DC3363;
      --ink:#222;
      --muted:#777;
      --line:#e6e6e6;
      --bg:#fff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:20px;
      font-family: "Segoe UI", Arial, sans-serif;
      color:var(--ink); background:var(--bg);
    }
    h1{
      color:var(--brand); font-size:24px; font-weight:800; margin:0 0 16px;
    }
    .panel{
      border:2px solid var(--brand);
      border-radius:14px;
      padding:16px 18px;
      background:#fff;
      margin:12px 0;
      box-shadow:0 3px 10px rgba(0,0,0,.04);
    }
    .panel h2{
      margin:0 0 10px; color:var(--brand); font-size:16px; font-weight:800; text-transform:uppercase;
    }
    label{display:block; font-size:13px; color:var(--muted); margin-bottom:4px}
    input, select, textarea{
      width:100%; padding:8px 10px; border:1px solid var(--line); border-radius:8px; font-size:14px;
      background:#fff; color:var(--ink);
    }
    textarea{min-height:90px; resize:vertical}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .col{flex:1}
    .narrow{flex:0 0 200px}
    .btn{
      border:1px solid var(--brand); background:var(--brand); color:#fff;
      border-radius:8px; padding:7px 12px; font-weight:700; cursor:pointer; transition:.15s;
    }
    .btn:hover{filter:brightness(.95)}
    table{width:100%; border-collapse:collapse; margin-top:8px}
    th,td{border-bottom:1px solid var(--line); padding:6px 8px; text-align:left; font-size:14px}
    th{color:var(--muted); font-size:12px}
    .note{font-size:12px; color:var(--muted)}
    footer{border-top:1px solid var(--line); margin-top:22px; padding-top:8px; text-align:center; font-size:12px; color:var(--muted)}

    /* Autocomplete rues */
    .ac-wrap{position:relative}
    .ac-list{position:absolute; left:0; right:0; top:100%; background:#fff; border:1px solid var(--line); border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,.06); max-height:220px; overflow:auto; z-index:10}
    .ac-item{padding:8px 10px; cursor:pointer}
    .ac-item:hover{background:#fafafa}

    /* Impression */
    @media print{
      body{background:#fff; padding:10mm}
      .btn, .no-print, .competences{display:none!important}
      .panel{box-shadow:none; page-break-inside:avoid}
    }
  </style>
</head>
<body>
  <h1>Fiche chantier — ST8 PRO</h1>

  <!-- Encadré administratif COMPLET (conforme croquis) -->
  <section class="panel" id="admin">
    <h2>Bloc administratif</h2>
    <div class="row">
      <div class="col">
        <label>Référence chantier (auto)</label>
        <input id="ref" placeholder="Ex : ST8-2025-014" />
      </div>
      <div class="narrow">
        <label>Date</label>
        <input id="date" type="date" />
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>N° Bon d’intervention</label>
        <input id="bon" />
      </div>
      <div class="col">
        <label>N° GDU</label>
        <input id="gdu" />
      </div>
      <div class="col">
        <label>N° DICT</label>
        <input id="dict" />
      </div>
      <div class="col">
        <label>N° Arrêté</label>
        <input id="arrete" />
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>Contacts</label>
        <textarea id="contacts" placeholder="Nom, tél, email…"></textarea>
      </div>
    </div>
  </section>

  <!-- Nature -->
  <section class="panel" id="nature">
    <h2>Nature des travaux / descriptif</h2>
    <textarea id="natureText" placeholder="Décrivez précisément les travaux à effectuer…"></textarea>
  </section>

  <!-- Localisation -->
  <section class="panel" id="localisation">
    <h2>Localisation du chantier</h2>
    <div class="row">
      <div class="narrow">
        <label>N°</label>
        <input id="numRue" />
      </div>
      <div class="col ac-wrap">
        <label>Rue</label>
        <input id="rue" autocomplete="off" placeholder="Commencez à taper…" />
        <div id="ac-rue" class="ac-list" hidden></div>
      </div>
      <div class="col">
        <label>Quartier / Secteur</label>
        <input id="quartier" />
      </div>
    </div>
  </section>

  <!-- Compétences (encadré séparé, NON imprimé) -->
  <section class="panel competences" id="competences">
    <h2>Compétences (aide au choix d’équipe)</h2>
    <div class="row">
      <label><input type="checkbox" value="pavage"> Pavage</label>
      <label><input type="checkbox" value="terrassement"> Terrassement</label>
      <label><input type="checkbox" value="voirie"> Voirie</label>
      <label><input type="checkbox" value="nettoyage"> Nettoyage</label>
      <label><input type="checkbox" value="signalisation"> Signalisation</label>
    </div>
    <div class="note">Encadré utile à l’écran, masqué à l’impression.</div>
  </section>

  <!-- Encadré unique : Équipe + Véhicules + Outillage -->
  <section class="panel" id="bloc-exec">
    <h2>Équipe, véhicules et outillage</h2>

    <!-- Équipe -->
    <div class="row no-print" style="margin-bottom:8px">
      <input id="agentNom" class="col" placeholder="Nom de l'agent" />
      <input id="agentSkill" class="col" placeholder="Compétence (ex. paveur, enginiste…)" />
      <select id="agentPermis" class="narrow">
        <option value="">Permis</option><option value="B">B</option><option value="PL">PL</option>
      </select>
      <button id="addAgent" class="btn">Ajouter agent +</button>
    </div>
    <table id="tabEquipe" aria-label="Équipe">
      <thead><tr><th>Agent</th><th>Compétence</th><th>Permis</th><th class="no-print">Action</th></tr></thead>
      <tbody></tbody>
    </table>

    <!-- Véhicules & Outillage (même section) -->
    <div class="row no-print" style="margin-top:14px; gap:8px">
      <input id="equipInput" class="col" placeholder="Ajouter un véhicule ou un outillage" />
      <button id="addEquip" class="btn">Ajouter équipement +</button>
    </div>
    <table id="tabEquip" aria-label="Véhicules et outillage">
      <thead><tr><th>Équipement</th><th class="no-print">Action</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="note">Exclusions automatiques : “CARTOUCHE FILTRANTE GLUTTON (par 4)”, tout ce qui contient “GOUPILLE”, “JEU DE CHASSE GOUPILLE LOT09”.</div>
  </section>

  <!-- Schéma / Photos -->
  <section class="panel schema" id="schema">
    <h2>Schéma / photos</h2>
    <div class="no-print" style="margin-bottom:8px">
      <input id="schemaFile" type="file" accept="image/*" class="btn" />
    </div>
    <img id="schemaPreview" alt="" style="max-width:100%; display:none; border:1px solid #ddd; border-radius:8px" />
    <div class="note">Visible et imprimable uniquement si un fichier est ajouté.</div>
  </section>

  <!-- Matériaux ESP -->
  <section class="panel" id="materiaux">
    <h2>Matériaux ESP</h2>
    <div class="row no-print" style="margin-bottom:8px">
      <input id="matCode" placeholder="Code ESP" class="narrow">
      <input id="matLabel" placeholder="Désignation" class="col">
      <button id="addMat" class="btn">Ajouter matériau +</button>
    </div>
    <table id="tabMat">
      <thead><tr><th>Code</th><th>Désignation</th><th class="no-print">Action</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <footer>© ST8 — Préparation de chantier</footer>

<script>
  // ===== Données de base (local) =====
  const DATA = {
    streets: [
      "Avenue Victor Hugo","Rue de la Paix","Boulevard Voltaire","Rue Pasteur",
      "Rue des Marronniers","Place du Marché","Rue Anatole France","Rue Victor Hugo",
      "Rue de la République","Boulevard Saint-Germain","Quai de la Loire","Allée des Peupliers"
    ],
    exclusions: [
      "CARTOUCHE FILTRANTE GLUTTON (PAR 4)",
      "GOUPILLE",
      "JEU DE CHASSE GOUPILLE LOT09"
    ]
  };

  // ===== Helpers =====
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const storageKey = "st8_prepa_final_v1";

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function isExcluded(name){
    const n = (name||"").toUpperCase();
    return DATA.exclusions.some(ex => n.includes(ex));
  }
  function addRow(tbodySel, cells){
    const tb = document.querySelector(tbodySel);
    const tr = document.createElement('tr');
    cells.forEach(c=>{
      const td=document.createElement('td'); td.textContent=c; tr.appendChild(td);
    });
    const td=document.createElement('td'); td.className="no-print";
    const b=document.createElement('button'); b.className="btn"; b.textContent="Supprimer";
    b.onclick=()=>{ tr.remove(); saveState(); };
    td.appendChild(b); tr.appendChild(td);
    tb.appendChild(tr);
  }
  function tableToData(sel){
    return $$(sel+' tbody tr').map(tr => Array.from(tr.children).slice(0,-1).map(td=>td.textContent));
  }

  // ===== Admin: date auto au 1er chargement =====
  window.addEventListener('DOMContentLoaded', ()=>{
    const saved = JSON.parse(localStorage.getItem(storageKey) || "null");
    if(saved) applyState(saved);
    else $('#date').value = new Date().toISOString().slice(0,10);
  });

  // ===== Autocomplete rues =====
  $('#rue').addEventListener('input', e=>{
    const val = e.target.value.toLowerCase();
    const ac = $('#ac-rue');
    if(!val){ ac.hidden=true; ac.innerHTML=""; return; }
    const list = DATA.streets
      .filter(s => s.toLowerCase().startsWith(val[0]) && s.toLowerCase().includes(val))
      .slice(0,20);
    ac.innerHTML = list.map(m=>`<div class="ac-item">${m}</div>`).join('');
    ac.hidden = list.length===0;
  });
  $('#ac-rue').addEventListener('click', e=>{
    const it = e.target.closest('.ac-item'); if(!it) return;
    $('#rue').value = it.textContent; $('#ac-rue').hidden = true; saveState();
  });
  document.addEventListener('click', e=>{
    const ac = $('#ac-rue'); if(!ac.contains(e.target) && e.target!==$('#rue')) ac.hidden = true;
  });

  // ===== Ajout Équipe =====
  $('#addAgent').onclick = ()=>{
    const nom = $('#agentNom').value.trim();
    const skill = $('#agentSkill').value.trim();
    const permis = $('#agentPermis').value;
    if(!nom) return;
    addRow('#tabEquipe',[nom,skill,permis]);
    $('#agentNom').value=''; $('#agentSkill').value=''; $('#agentPermis').value='';
    saveState();
  };

  // ===== Ajout Équipements (véhicules + outillage) =====
  $('#addEquip').onclick = ()=>{
    const name = $('#equipInput').value.trim();
    if(!name) return;
    if(isExcluded(name)) { alert("Équipement exclu par les règles ST8."); return; }
    addRow('#tabEquip',[name]);
    $('#equipInput').value='';
    saveState();
  };

  // ===== Matériaux ESP =====
  $('#addMat').onclick = ()=>{
    const code = $('#matCode').value.trim();
    const label = $('#matLabel').value.trim();
    if(!code || !label) return;
    if(isExcluded(label)) { alert("Article exclu par les règles ST8."); return; }
    addRow('#tabMat',[code,label]);
    $('#matCode').value=''; $('#matLabel').value='';
    saveState();
  };

  // ===== Schéma / Photos =====
  $('#schemaFile').addEventListener('change', e=>{
    const f = e.target.files?.[0]; if(!f) return;
    const rd = new FileReader();
    rd.onload = ()=>{
      $('#schemaPreview').src = rd.result;
      $('#schemaPreview').style.display = 'block';
      saveState();
    };
    rd.readAsDataURL(f);
  });

  // ===== Sauvegarde auto =====
  function collectState(){
    return {
      admin:{
        ref:$('#ref').value, date:$('#date').value, bon:$('#bon').value, gdu:$('#gdu').value,
        dict:$('#dict').value, arrete:$('#arrete').value, contacts:$('#contacts').value
      },
      nature: $('#natureText').value,
      loc: { numRue:$('#numRue').value, rue:$('#rue').value, quartier:$('#quartier').value },
      equipe: tableToData('#tabEquipe'),
      equip: tableToData('#tabEquip'),
      mat: tableToData('#tabMat'),
      schema: $('#schemaPreview').style.display!=='none' ? $('#schemaPreview').src : ''
    };
  }
  function applyState(s){
    if(!s) return;
    const A = s.admin||{};
    $('#ref').value = A.ref||'';
    $('#date').value = A.date||new Date().toISOString().slice(0,10);
    $('#bon').value = A.bon||'';
    $('#gdu').value = A.gdu||'';
    $('#dict').value = A.dict||'';
    $('#arrete').value = A.arrete||'';
    $('#contacts').value = A.contacts||'';

    $('#natureText').value = s.nature||'';
    $('#numRue').value = s.loc?.numRue||'';
    $('#rue').value = s.loc?.rue||'';
    $('#quartier').value = s.loc?.quartier||'';

    const fill = (sel, rows)=>{ const tb=document.querySelector(sel+' tbody'); tb.innerHTML=''; (rows||[]).forEach(r=>addRow(sel,r)); };
    fill('#tabEquipe', s.equipe);
    fill('#tabEquip', s.equip);
    fill('#tabMat', s.mat);

    if(s.schema){ $('#schemaPreview').src=s.schema; $('#schemaPreview').style.display='block'; }
  }
  function saveState(){ localStorage.setItem(storageKey, JSON.stringify(collectState())); }

  $$('input,textarea,select').forEach(el=>{
    el.addEventListener('input', saveState);
    el.addEventListener('change', saveState);
  });
</script>
</body>
</html>
